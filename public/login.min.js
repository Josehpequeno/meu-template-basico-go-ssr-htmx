function spinner(){document.getElementById("spinner").classList.remove("hidden");document.getElementById("submit").disabled=true}function resetMensages(noClear){const message=document.getElementById("message");const sucessDiv=document.getElementById("sucess");const infoDiv=document.getElementById("info");if(!message.classList.contains("hidden")&&noClear!=="message"){message.classList.add("hidden")}if(!sucessDiv.classList.contains("hidden")&&noClear!=="sucess"){sucessDiv.classList.add("hidden")}if(!infoDiv.classList.contains("hidden")&&noClear!=="info"){sucessDiv.classList.add("hidden")}}htmx.on("htmx:afterOnLoad",function(event){try{resetMensages("message");var response=event.detail.xhr.responseText;var jsonResponse=JSON.parse(response);if(jsonResponse.user&&jsonResponse.redirect){localStorage.setItem("user",JSON.stringify(jsonResponse.user));window.location.href=jsonResponse.redirect}}catch(e){}});htmx.on("htmx:beforeSwap",function(event){try{var response=event.detail.xhr.responseText;var jsonResponse=JSON.parse(response);if(!jsonResponse.user&&jsonResponse.error){document.getElementById("submit").disabled=false;document.getElementById("spinner").classList.add("hidden");document.getElementById("message").classList.remove("hidden");document.querySelector("#message").innerHTML=`<span class="block sm:inline">${jsonResponse.error}</span>`;event.preventDefault()}}catch(e){}});function changeVisility(){var show=document.getElementById("show");var close=document.getElementById("close");var password=document.getElementById("password");if(show.classList.contains("hidden")){show.classList.remove("hidden");close.classList.add("hidden");password.type="text"}else{show.classList.add("hidden");close.classList.remove("hidden");password.type="password"}}htmx.onLoad(function(){const message=sessionStorage.getItem("message");if(message){const sucessDiv=document.getElementById("sucess");sucessDiv.querySelector("span").textContent=message;sucessDiv.classList.remove("hidden");sessionStorage.removeItem("message")}});if(window.location.pathname!=="/login"){window.location.reload()}function handleCredentialResponse(response){fetch("/auth/google",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:response.credential})}).then(res=>res.json()).then(data=>{if(data.user&&data.redirect){localStorage.setItem("user",JSON.stringify(data.user));window.location.href=data.redirect}else{resetMensages("info");document.getElementById("submit").disabled=false;document.getElementById("spinner").classList.add("hidden");document.getElementById("info").classList.remove("hidden");document.querySelector("#info").innerHTML=`<span class="block sm:inline">${data.message}</span>`}}).catch(err=>{console.error("Erro ao enviar token:",err.response)})}let supportsFedCmMode=false;try{navigator.credentials.get({identity:Object.defineProperty({},"mode",{get:function(){supportsFedCmMode=true}})})}catch(e){console.log(e)}if(supportsFedCmMode){(async()=>await navigator.credentials.get({identity:{context:"login",providers:[{configURL:"https://accounts.google.com/.well-known/openid-configuration",clientId:"client_id.apps.googleusercontent.com",nonce:"nonce"}],mode:"active"}}))()}function setWithExpiry(key,value,ttlInMs){const now=Date.now();const item={value:value,expiry:now+ttlInMs};localStorage.setItem(key,JSON.stringify(item))}function getWithExpiry(key){const itemStr=localStorage.getItem(key);if(!itemStr)return null;const item=JSON.parse(itemStr);const now=Date.now();if(now>item.expiry){localStorage.removeItem(key);return null}return item.value}function handleLoginSuccess(json){setWithExpiry("access_token",json.access_token,6*60*60*1e3);setWithExpiry("refresh_token",json.refresh_token,6*60*60*1e3);setWithExpiry("user",JSON.stringify({password:null,...json.user}),6*60*60*1e3);const role=json.user.Role.toLowerCase();if(role==="normal"){console.log("User normal detected, redirecting to /aluno");window.location.href="/"}else if(role==="master"){console.log("User master detected, redirecting to /");window.location.href="/"}else{console.warn("Role desconhecido:",json.user.Role);window.location.href="/"}}htmx.on("htmx:afterRequest",function(evt){if(evt.detail.elt.id!=="loginForm")return;const text=evt.detail.xhr.responseText;try{const json=JSON.parse(text);console.log("Resposta do login:",json);if(json.user&&json.access_token&&json.refresh_token){handleLoginSuccess(json)}}catch(e){console.error("Resposta inv√°lida no login:",e)}});